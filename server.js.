// server.js - ìƒí™œì ˆê¸° ë†ì—…ì•± ë°±ì—”ë“œ ì„œë²„
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const morgan = require('morgan');
const rateLimit = require('express-rate-limit');
const { Pool } = require('pg');
const jwt = require('jsonwebtoken');
const bcrypt = require('bcryptjs');
const axios = require('axios');

const app = express();
const PORT = process.env.PORT || 3000;

// ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
const pool = new Pool({
  connectionString: process.env.DATABASE_URL || 'postgresql://postgres:password@localhost:5432/living_seasons',
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

// ë¯¸ë“¤ì›¨ì–´ ì„¤ì •
app.use(helmet());
app.use(cors());
app.use(morgan('combined'));
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true }));

// Rate Limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15ë¶„
  max: 100 // ìµœëŒ€ 100ê°œ ìš”ì²­
});
app.use('/api/', limiter);

// JWT ì¸ì¦ ë¯¸ë“¤ì›¨ì–´
const authenticateToken = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({ error: 'ì•¡ì„¸ìŠ¤ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤' });
  }

  jwt.verify(token, process.env.JWT_SECRET || 'default_secret', (err, user) => {
    if (err) {
      return res.status(403).json({ error: 'ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤' });
    }
    req.user = user;
    next();
  });
};

// ===================
// 1. ì‚¬ìš©ì ì¸ì¦ API
// ===================

// íšŒì›ê°€ì…
app.post('/api/auth/register', async (req, res) => {
  try {
    const { email, password, name, phone, region } = req.body;
    
    // ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸
    const existingUser = await pool.query(
      'SELECT user_id FROM users WHERE email = $1',
      [email]
    );
    
    if (existingUser.rows.length > 0) {
      return res.status(400).json({ error: 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤' });
    }
    
    // ë¹„ë°€ë²ˆí˜¸ í•´ì‹œí™”
    const hashedPassword = await bcrypt.hash(password, 10);
    
    // ì‚¬ìš©ì ìƒì„±
    const newUser = await pool.query(
      `INSERT INTO users (email, password_hash, name, phone, region, created_at)
       VALUES ($1, $2, $3, $4, $5, NOW())
       RETURNING user_id, email, name, region`,
      [email, hashedPassword, name, phone, region]
    );
    
    // JWT í† í° ìƒì„±
    const token = jwt.sign(
      { userId: newUser.rows[0].user_id, email: newUser.rows[0].email },
      process.env.JWT_SECRET || 'default_secret',
      { expiresIn: '24h' }
    );
    
    res.status(201).json({
      message: 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
      user: newUser.rows[0],
      token
    });
    
  } catch (error) {
    console.error('íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' });
  }
});

// ë¡œê·¸ì¸
app.post('/api/auth/login', async (req, res) => {
  try {
    const { email, password } = req.body;
    
    // ì‚¬ìš©ì í™•ì¸
    const user = await pool.query(
      'SELECT user_id, email, password_hash, name, region FROM users WHERE email = $1',
      [email]
    );
    
    if (user.rows.length === 0) {
      return res.status(401).json({ error: 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤' });
    }
    
    // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    const validPassword = await bcrypt.compare(password, user.rows[0].password_hash);
    
    if (!validPassword) {
      return res.status(401).json({ error: 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤' });
    }
    
    // JWT í† í° ìƒì„±
    const token = jwt.sign(
      { userId: user.rows[0].user_id, email: user.rows[0].email },
      process.env.JWT_SECRET || 'default_secret',
      { expiresIn: '24h' }
    );
    
    res.json({
      message: 'ë¡œê·¸ì¸ ì„±ê³µ',
      user: {
        user_id: user.rows[0].user_id,
        email: user.rows[0].email,
        name: user.rows[0].name,
        region: user.rows[0].region
      },
      token
    });
    
  } catch (error) {
    console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' });
  }
});

// ===================
// 2. ìƒí™œì ˆê¸° API
// ===================

// í˜„ì¬ ì ˆê¸° ì •ë³´ ì¡°íšŒ
app.get('/api/seasons/current', authenticateToken, async (req, res) => {
  try {
    const { userId } = req.user;
    const today = new Date();
    
    // ì‚¬ìš©ì ì§€ì—­ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const userInfo = await pool.query(
      'SELECT region FROM users WHERE user_id = $1',
      [userId]
    );
    
    if (userInfo.rows.length === 0) {
      return res.status(404).json({ error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' });
    }
    
    const region = userInfo.rows[0].region;
    
    // í˜„ì¬ ì ˆê¸° ê³„ì‚°
    const currentSeason = calculateCurrentSeason(today);
    const livingSeason = await calculateLivingSeason(region, today);
    
    res.json({
      traditional_season: currentSeason,
      living_season: livingSeason,
      region: region,
      date: today.toISOString().split('T')[0]
    });
    
  } catch (error) {
    console.error('í˜„ì¬ ì ˆê¸° ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' });
  }
});

// ===================
// 3. ê¸°ìƒ ë°ì´í„° API
// ===================

// í˜„ì¬ ë‚ ì”¨ ì¡°íšŒ
app.get('/api/weather/current', authenticateToken, async (req, res) => {
  try {
    const { userId } = req.user;
    
    // ì‚¬ìš©ì ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const userLocation = await pool.query(
      `SELECT u.region, uf.latitude, uf.longitude 
       FROM users u 
       LEFT JOIN user_fields uf ON u.user_id = uf.user_id 
       WHERE u.user_id = $1 
       LIMIT 1`,
      [userId]
    );
    
    if (userLocation.rows.length === 0) {
      return res.status(404).json({ error: 'ì‚¬ìš©ì ìœ„ì¹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' });
    }
    
    const { region, latitude, longitude } = userLocation.rows[0];
    
    // ê¸°ìƒì²­ API í˜¸ì¶œ (í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„°)
    const weatherData = {
      temperature: 22,
      humidity: 65,
      wind_speed: 2.1,
      precipitation: 0,
      pressure: 1013.2,
      uv_index: 6,
      recorded_at: new Date().toISOString()
    };
    
    // ë†ì—…ìš© ìœ„í—˜ë„ ê³„ì‚°
    const riskAssessment = calculateWeatherRisk(weatherData);
    
    res.json({
      location: { region, latitude, longitude },
      current_weather: weatherData,
      risk_assessment: riskAssessment,
      recommendations: generateWeatherRecommendations(weatherData, riskAssessment)
    });
    
  } catch (error) {
    console.error('ë‚ ì”¨ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' });
  }
});

// ===================
// 4. ë†ì¥ ê´€ë¦¬ API
// ===================

// ì‚¬ìš©ì ë†ì¥ ëª©ë¡ ì¡°íšŒ
app.get('/api/farms', authenticateToken, async (req, res) => {
  try {
    const { userId } = req.user;
    
    const farms = await pool.query(
      `SELECT field_id, field_name, crop_type, area_size, area_unit,
              latitude, longitude, created_at
       FROM user_fields 
       WHERE user_id = $1 
       ORDER BY created_at DESC`,
      [userId]
    );
    
    res.json({
      farms: farms.rows,
      total_count: farms.rows.length
    });
    
  } catch (error) {
    console.error('ë†ì¥ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ë†ì¥ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' });
  }
});

// ìƒˆ ë†ì¥ ë“±ë¡
app.post('/api/farms', authenticateToken, async (req, res) => {
  try {
    const { userId } = req.user;
    const { field_name, crop_type, area_size, area_unit, latitude, longitude } = req.body;
    
    const newFarm = await pool.query(
      `INSERT INTO user_fields 
       (user_id, field_name, crop_type, area_size, area_unit, latitude, longitude, created_at)
       VALUES ($1, $2, $3, $4, $5, $6, $7, NOW())
       RETURNING *`,
      [userId, field_name, crop_type, area_size, area_unit, latitude, longitude]
    );
    
    res.status(201).json({
      message: 'ë†ì¥ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤',
      farm: newFarm.rows[0]
    });
    
  } catch (error) {
    console.error('ë†ì¥ ë“±ë¡ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ë†ì¥ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤' });
  }
});

// ===================
// 5. ì»¤ë®¤ë‹ˆí‹° API
// ===================

// ì§€ì—­ ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œê¸€ ëª©ë¡
app.get('/api/community/posts', authenticateToken, async (req, res) => {
  try {
    const { userId } = req.user;
    const { page = 1, limit = 20, category } = req.query;
    const offset = (page - 1) * limit;
    
    // ì‚¬ìš©ì ì§€ì—­ ì •ë³´
    const userRegion = await pool.query(
      'SELECT region FROM users WHERE user_id = $1',
      [userId]
    );
    
    const region = userRegion.rows[0].region;
    
    // ì§€ì—­ ê¸°ë°˜ ê²Œì‹œê¸€ ì¡°íšŒ
    let query = `
      SELECT cp.post_id, cp.title, cp.content, cp.category, cp.created_at,
             u.name as author_name, u.region as author_region
      FROM community_posts cp
      JOIN users u ON cp.user_id = u.user_id
      WHERE u.region = $1`;
    
    const queryParams = [region];
    
    if (category) {
      query += ` AND cp.category = $${queryParams.length + 1}`;
      queryParams.push(category);
    }
    
    query += ` ORDER BY cp.created_at DESC
               LIMIT $${queryParams.length + 1} OFFSET $${queryParams.length + 2}`;
    
    queryParams.push(limit, offset);
    
    const posts = await pool.query(query, queryParams);
    
    res.json({
      posts: posts.rows,
      pagination: {
        current_page: parseInt(page),
        total_pages: Math.ceil(posts.rows.length / limit),
        region: region
      }
    });
    
  } catch (error) {
    console.error('ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œê¸€ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ê²Œì‹œê¸€ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' });
  }
});

// ìƒˆ ê²Œì‹œê¸€ ì‘ì„±
app.post('/api/community/posts', authenticateToken, async (req, res) => {
  try {
    const { userId } = req.user;
    const { title, content, category } = req.body;
    
    const newPost = await pool.query(
      `INSERT INTO community_posts (user_id, title, content, category, created_at)
       VALUES ($1, $2, $3, $4, NOW())
       RETURNING post_id, title, content, category, created_at`,
      [userId, title, content, category]
    );
    
    res.status(201).json({
      message: 'ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤',
      post: newPost.rows[0]
    });
    
  } catch (error) {
    console.error('ê²Œì‹œê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ê²Œì‹œê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤' });
  }
});

// ===================
// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
// ===================

// í˜„ì¬ ì ˆê¸° ê³„ì‚°
function calculateCurrentSeason(date) {
  const month = date.getMonth() + 1;
  const day = date.getDate();
  
  // 24ì ˆê¸° ëŒ€ëµì ì¸ ë‚ ì§œ
  const seasons = [
    { name: 'ì†Œí•œ', month: 1, day: 5 },
    { name: 'ëŒ€í•œ', month: 1, day: 20 },
    { name: 'ì…ì¶˜', month: 2, day: 4 },
    { name: 'ìš°ìˆ˜', month: 2, day: 19 },
    { name: 'ê²½ì¹©', month: 3, day: 5 },
    { name: 'ì¶˜ë¶„', month: 3, day: 20 },
    { name: 'ì²­ëª…', month: 4, day: 5 },
    { name: 'ê³¡ìš°', month: 4, day: 20 },
    { name: 'ì…í•˜', month: 5, day: 5 },
    { name: 'ì†Œë§Œ', month: 5, day: 21 },
    { name: 'ë§ì¢…', month: 6, day: 5 },
    { name: 'í•˜ì§€', month: 6, day: 21 },
    { name: 'ì†Œì„œ', month: 7, day: 7 },
    { name: 'ëŒ€ì„œ', month: 7, day: 23 },
    { name: 'ì…ì¶”', month: 8, day: 7 },
    { name: 'ì²˜ì„œ', month: 8, day: 23 },
    { name: 'ë°±ë¡œ', month: 9, day: 7 },
    { name: 'ì¶”ë¶„', month: 9, day: 23 },
    { name: 'í•œë¡œ', month: 10, day: 8 },
    { name: 'ìƒê°•', month: 10, day: 23 },
    { name: 'ì…ë™', month: 11, day: 7 },
    { name: 'ì†Œì„¤', month: 11, day: 22 },
    { name: 'ëŒ€ì„¤', month: 12, day: 7 },
    { name: 'ë™ì§€', month: 12, day: 22 }
  ];
  
  // í˜„ì¬ ë‚ ì§œì— ê°€ì¥ ê°€ê¹Œìš´ ì´ì „ ì ˆê¸° ì°¾ê¸°
  let currentSeason = seasons[0];
  for (let i = 0; i < seasons.length; i++) {
    const season = seasons[i];
    if (month < season.month || (month === season.month && day < season.day)) {
      break;
    }
    currentSeason = season;
  }
  
  return currentSeason;
}

// ìƒí™œì ˆê¸° ê³„ì‚°
async function calculateLivingSeason(region, date) {
  try {
    // ì§€ì—­ë³„ ê¸°ì˜¨ ë³´ì •ê°’ ì¡°íšŒ
    const regionCorrection = await pool.query(
      'SELECT temperature_offset FROM region_corrections WHERE region = $1',
      [region]
    );
    
    const tempOffset = regionCorrection.rows[0]?.temperature_offset || 0;
    
    // ê¸°ë³¸ ì ˆê¸°ì—ì„œ ë³´ì •ê°’ë§Œí¼ ì¡°ì •
    const traditionalSeason = calculateCurrentSeason(date);
    
    // ì˜¨ë„ê°€ ë†’ìœ¼ë©´ ì ˆê¸°ê°€ ë¹¨ë¼ì§
    const adjustmentDays = Math.round(tempOffset * 2);
    
    return {
      ...traditionalSeason,
      adjustment_days: adjustmentDays,
      adjusted_name: adjustmentDays !== 0 ? `${traditionalSeason.name} (${adjustmentDays > 0 ? '+' : ''}${adjustmentDays}ì¼)` : traditionalSeason.name
    };
    
  } catch (error) {
    console.error('ìƒí™œì ˆê¸° ê³„ì‚° ì˜¤ë¥˜:', error);
    return calculateCurrentSeason(date);
  }
}

// ë‚ ì”¨ ìœ„í—˜ë„ ê³„ì‚°
function calculateWeatherRisk(weatherData) {
  let riskLevel = 'low';
  let riskFactors = [];
  
  // ì˜¨ë„ ìœ„í—˜ë„
  if (weatherData.temperature > 35) {
    riskLevel = 'high';
    riskFactors.push('ê·¹í•œ ê³ ì˜¨');
  } else if (weatherData.temperature > 30) {
    riskLevel = 'medium';
    riskFactors.push('ê³ ì˜¨');
  }
  
  // ìŠµë„ ìœ„í—˜ë„
  if (weatherData.humidity > 80) {
    if (riskLevel === 'low') riskLevel = 'medium';
    riskFactors.push('ë†’ì€ ìŠµë„');
  }
  
  // ê°•ìˆ˜ëŸ‰ ìœ„í—˜ë„
  if (weatherData.precipitation > 50) {
    riskLevel = 'high';
    riskFactors.push('í­ìš°');
  } else if (weatherData.precipitation > 10) {
    if (riskLevel === 'low') riskLevel = 'medium';
    riskFactors.push('ê°•ìš°');
  }
  
  return {
    risk_level: riskLevel,
    risk_factors: riskFactors,
    risk_score: riskLevel === 'high' ? 9 : riskLevel === 'medium' ? 5 : 1
  };
}

// ê¸°ìƒ ì¶”ì²œì‚¬í•­ ìƒì„±
function generateWeatherRecommendations(weatherData, riskAssessment) {
  const recommendations = [];
  
  if (riskAssessment.risk_level === 'high') {
    recommendations.push('ğŸš¨ ê¸´ê¸‰: ë†ì‘ì—… ì¤‘ë‹¨ ê¶Œê³ ');
    
    if (riskAssessment.risk_factors.includes('ê·¹í•œ ê³ ì˜¨')) {
      recommendations.push('ğŸŒ¡ï¸ ì°¨ê´‘ë§ ì„¤ì¹˜ ë° ê´€ìˆ˜ ì‹œìŠ¤í…œ ê°€ë™');
    }
    
    if (riskAssessment.risk_factors.includes('í­ìš°')) {
      recommendations.push('ğŸŒ§ï¸ ë°°ìˆ˜ ì‹œì„¤ ì ê²€ ë° í† ì–‘ ì¹¨ìˆ˜ ë°©ì§€');
    }
  }
  
  if (riskAssessment.risk_level === 'medium') {
    recommendations.push('âš ï¸ ì£¼ì˜: ë†ì‘ì—… ì‹œ ê°ë³„í•œ ì£¼ì˜ í•„ìš”');
    
    if (weatherData.temperature > 30) {
      recommendations.push('ğŸ• ì˜¤ì „ ë˜ëŠ” ì €ë… ì‹œê°„ëŒ€ì— ì‘ì—…í•˜ì„¸ìš”');
    }
  }
  
  if (riskAssessment.risk_level === 'low') {
    recommendations.push('âœ… ë†ì‘ì—…ì— ì í•©í•œ ë‚ ì”¨ì…ë‹ˆë‹¤');
    
    if (weatherData.humidity < 60 && weatherData.precipitation === 0) {
      recommendations.push('ğŸ’§ ê´€ìˆ˜ ì‘ì—…ì— ì¢‹ì€ ì¡°ê±´ì…ë‹ˆë‹¤');
    }
  }
  
  return recommendations;
}

// í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸
app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    message: 'ğŸŒ¾ ìƒí™œì ˆê¸° ë†ì—… API ì„œë²„ê°€ ì •ìƒ ë™ì‘ ì¤‘ì…ë‹ˆë‹¤',
    timestamp: new Date().toISOString() 
  });
});

// ê¸°ë³¸ ê²½ë¡œ
app.get('/', (req, res) => {
  res.json({
    message: 'ğŸŒ¾ ìƒí™œì ˆê¸° ë†ì—… APIì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!',
    version: '1.0.0',
    endpoints: [
      'POST /api/auth/register - íšŒì›ê°€ì…',
      'POST /api/auth/login - ë¡œê·¸ì¸',
      'GET /api/seasons/current - í˜„ì¬ ì ˆê¸°',
      'GET /api/weather/current - í˜„ì¬ ë‚ ì”¨',
      'GET /api/farms - ë†ì¥ ëª©ë¡',
      'POST /api/farms - ë†ì¥ ë“±ë¡',
      'GET /api/community/posts - ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œê¸€',
      'POST /api/community/posts - ê²Œì‹œê¸€ ì‘ì„±',
      'GET /api/health - ì„œë²„ ìƒíƒœ'
    ]
  });
});

// ì—ëŸ¬ í•¸ë“¤ëŸ¬
app.use((err, req, res, next) => {
  console.error('ì„œë²„ ì˜¤ë¥˜:', err);
  res.status(500).json({ 
    error: 'ë‚´ë¶€ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
    message: process.env.NODE_ENV === 'development' ? err.message : 'ì„œë²„ ì˜¤ë¥˜'
  });
});

// 404 í•¸ë“¤ëŸ¬
app.use('*', (req, res) => {
  res.status(404).json({ error: 'ìš”ì²­í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' });
});

// ì„œë²„ ì‹œì‘
app.listen(PORT, () => {
  console.log(`ğŸŒ¾ ìƒí™œì ˆê¸° ë†ì—… API ì„œë²„ê°€ í¬íŠ¸ ${PORT}ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤`);
  console.log(`ğŸ“± í™˜ê²½: ${process.env.NODE_ENV || 'development'}`);
  console.log(`ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤: ${process.env.DATABASE_URL ? 'ì—°ê²°ë¨' : 'ê¸°ë³¸ ì„¤ì • ì‚¬ìš©'}`);
  console.log(`ğŸ”— API ë¬¸ì„œ: http://localhost:${PORT}`);
});

// ìš°ì•„í•œ ì¢…ë£Œ
process.on('SIGTERM', () => {
  console.log('ì„œë²„ê°€ ì¢…ë£Œë©ë‹ˆë‹¤...');
  pool.end(() => {
    console.log('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
    process.exit(0);
  });
});

module.exports = app;
